<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <template id="report_account_entries_view">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="web.external_layout">
                        <div class="page">

                            <t t-set="o" t-value="o.with_context(lang=lang)"/>
                            <div class="page">
                                <br/>
                                <br/>
                                <h2>
                                    <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Factura</span>
                                    <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Factura
                                        Borrador</span>
                                    <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Factura
                                        Cancelada</span>
                                    <span t-if="o.move_type == 'out_refund'">Nota de Crédito</span>
                                    <span t-if="o.move_type == 'in_refund'">Nota de Crédito de Proveedor</span>
                                    <span t-if="o.move_type == 'in_invoice'">Factura de Proveedor</span>
                                    <span t-if="o.name != '/'" t-field="o.name"/>
                                </h2>
                                <div id="informations" class="row mt32 mb32">
                                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.partner_id" name="invoice_date">
                                        <t t-if="o.move_type == 'in_invoice'">
                                            <strong>Proveedor:</strong>
                                        </t>
                                        <t t-else=""><strong>Cliente:</strong></t>
                                        <p class="m-0" t-field="o.partner_id"
                                           t-options='{"widget": "contact", "fields": ["address", "name" ,"phone"], "no_marker": False}'/>
                                    </div>
                                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_date" name="invoice_date">
                                        <strong>Fecha factura:</strong>
                                        <p class="m-0" t-field="o.invoice_date"/>
                                    </div>
                                    <div class="col-auto col-3 mw-100 mb-2"
                                         t-if="o.invoice_date_due and o.move_type == 'out_invoice' and o.state == 'posted'"
                                         name="due_date">
                                        <strong>Fecha de vcto:</strong>
                                        <p class="m-0" t-field="o.invoice_date_due"/>
                                    </div>
                                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_origin" name="origin">
                                        <strong>Origen:</strong>
                                        <p class="m-0" t-field="o.invoice_origin"/>
                                    </div>
                                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.partner_id.ref"
                                         name="customer_code">
                                        <strong>Código del cliente:</strong>
                                        <p class="m-0" t-field="o.partner_id.ref"/>
                                    </div>
                                    <div class="col-auto col-3 mw-100 mb-2" t-if="o.ref" name="reference">
                                        <strong>Número de Documento :</strong>
                                        <p class="m-0" t-field="o.l10n_latam_document_number"/>
                                    </div>
                                </div>


                                <table class="table table-sm o_main_table table-bordered" name="line_ids_table">
                                    <thead>
                                        <tr class="table-active">
                                            <th class="text-center" colspan="5"><h5>Apuntes Contables</h5></th>
                                        </tr>
                                        <tr>
                                            <th class="text-left"><span>Cuenta</span></th>
                                            <th class="text-left"><span>Etiqueta</span></th>
                                            <th class="text-left"><span>Etiquetas analíticas</span></th>
                                            <th class="text-right"><span>Debe</span></th>
                                            <th class="text-right"><span>Haber</span></th>
                                        </tr>
                                    </thead>
                                    <tbody class="invoice_tbody">
                                        <t t-set="total_debe" t-value="0"/>
                                        <t t-set="total_haber" t-value="0"/>
                                        <t t-set="lines"
                                           t-value="o.line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>

                                        <t t-foreach="lines" t-as="line">
                                            <t t-set="total_debe" t-value="total_debe + line.debit"/>
                                            <t t-set="total_haber" t-value="total_haber + line.credit"/>

                                            <tr>
                                                <td><span t-field="line.account_id"/></td>
                                                <td><span t-field="line.name" t-options="{'widget': 'text'}"/></td>
                                                <td>
                                                    <span t-esc="', '.join(map(str,line.analytic_tag_ids.mapped('name')))"
                                                    />
                                                </td>
                                                <td class="text-right o_price_total"><span t-field="line.debit"/></td>
                                                <td class="text-right o_price_total"><span t-field="line.credit"/></td>
                                            </tr>

                                        </t>

                                        <tr class="border-black o_total text-right">
                                            <td class="text-right o_price_total" colspan="4">
                                                <strong><span t-esc="total_debe"
                                                              t-options='{"widget": "monetary", "display_currency": line.currency_id}'
                                                /></strong>
                                            </td>

                                            <td class="text-right o_price_total">
                                                <strong><span t-esc="total_haber"
                                                              t-options='{"widget": "monetary", "display_currency": line.currency_id}'
                                                /></strong>
                                            </td>
                                        </tr>

                                    </tbody>
                                </table>


                            </div>

                        </div>
                    </t>
                </t>
            </t>
        </template>


        <record id="mueve_entries_a4_paperformat" model="report.paperformat">
            <field name="name">Asientos contables: A4</field>
            <field name="default" eval="True"/>
            <field name="format">A4</field>
            <field name="page_height">0</field>
            <field name="page_width">0</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">35</field>
            <field name="margin_bottom">25</field>
            <field name="margin_left">7</field>
            <field name="margin_right">7</field>
            <field name="header_line" eval="False"/>
            <field name="header_spacing">35</field>
            <field name="dpi">90</field>
        </record>

        <report
                id="action_report_account_entries"
                model="account.move"
                string="Apuntes contables"
                name="pe_edi_detraction.report_account_entries_view"
                file="pe_edi_detraction.report_account_entries"
                report_type="qweb-pdf"
                paperformat="pe_edi_detraction.mueve_entries_a4_paperformat"
        />

    </data>
</odoo>